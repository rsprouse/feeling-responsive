# This action builds the CLA website and copies the files to the public
# web server when a commit is pushed to github.

# In order for this action to work several environment variables must be
# defined as github secrets:

# DEPLOY_HOST: hostname of the public web server where the website will
#    be copied via rsync, e.g. linguistics.berkeley.edu
# DEPLOY_USER: username to be used for rsync on DEPLOY_HOST,
#    e.g. cla_deployer
# DEPLOY_PATH_PROD: filepath on DEPLOY_HOST where the production release
#    website will be copied, e.g. /home/sites/cla_public_jekyll/public_html
# DEPLOY_PATH_DEV: filepath on DEPLOY_HOST where the development
#    website will be copied, e.g. /home/sites/cla_public_trill/public_html
# GOOGLE_MAPS_API_KEY: developer key for Google Maps API, to be inserted
#    into website code
# SSH_KNOWN_HOSTS: List of known keys for DEPLOY_HOST, as generated by e.g.
#    `ssh-keyscan linguistics.berkeley.edu`
# SSH_PRIVATE_KEY: private key for DEPLOY_USER on DEPLOY_HOST. The key
#    must exist in DEPLOY_USER's `authorized_keys` file on DEPLOY_HOST.
#    PEM-encoded RSA keys are known to work and can be created with e.g.
#    `ssh-keygen -t rsa -b 4096 -m PEM`, and the private key can then
#    be copied to DEPLOY_HOST.


name: Build Dev CLA website with Jekyll and deploy to gh-pages-dev branch

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-20.04
 
    steps:
      - uses: actions/checkout@v2

      # Use GitHub Actions' cache to shorten build times and decrease load on servers
      - uses: actions/cache@v2
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      # Standard usage deploys to gh-pages branch
      - uses:  helaili/jekyll-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_branch: gh-pages-dev
          jekyll_env: development
          jekyll_build_options: --config _config.yml,_config_dev.yml
